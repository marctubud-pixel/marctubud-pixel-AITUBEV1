import jsPDF from 'jspdf';

// 1. è¾…åŠ©ï¼šå°†ç½‘ç»œå›¾ç‰‡è½¬ä¸º Base64 (è§£å†³ PDF è·¨åŸŸé»‘å±é—®é¢˜)
const getBase64ImageFromURL = (url: string): Promise<string> => {
  return new Promise((resolve, reject) => {
    const img = new Image();
    img.crossOrigin = 'Anonymous';
    img.src = url;
    img.onload = () => {
      const canvas = document.createElement('canvas');
      canvas.width = img.width;
      canvas.height = img.height;
      const ctx = canvas.getContext('2d');
      if (!ctx) return reject('Canvas error');
      ctx.drawImage(img, 0, 0);
      const dataURL = canvas.toDataURL('image/jpeg');
      resolve(dataURL);
    };
    img.onerror = (error) => reject(error);
  });
};

// 2. æ–°å¢ï¼šåŠ è½½ä¸­æ–‡å­—ä½“ (æ ¸å¿ƒä¿®å¤)
const loadChineseFont = async (doc: jsPDF) => {
  try {
    // ä½¿ç”¨ window.location.origin ç¡®ä¿è·¯å¾„ç»å¯¹æ­£ç¡®
    const fontUrl = `${window.location.origin}/fonts/custom-font.ttf`;
    console.log(`[PDF] æ­£åœ¨åŠ è½½å­—ä½“: ${fontUrl}`);
    
    const response = await fetch(fontUrl);
    if (!response.ok) {
        throw new Error(`å­—ä½“æ–‡ä»¶æœªæ‰¾åˆ° (${response.status})`);
    }
    
    const buffer = await response.arrayBuffer();
    
    // å°† ArrayBuffer è½¬ä¸º binary string
    let binary = '';
    const bytes = new Uint8Array(buffer);
    const len = bytes.byteLength;
    for (let i = 0; i < len; i++) {
      binary += String.fromCharCode(bytes[i]);
    }
    const base64Font = btoa(binary);

    // æ³¨å†Œå­—ä½“åˆ° jsPDF
    doc.addFileToVFS("CustomFont.ttf", base64Font);
    doc.addFont("CustomFont.ttf", "CustomFont", "normal");
    doc.setFont("CustomFont"); // è®¾ç½®ä¸ºå½“å‰å­—ä½“
    
    console.log("[PDF] âœ… ä¸­æ–‡å­—ä½“åŠ è½½æˆåŠŸ");
  } catch (e) {
    console.error("[PDF] âŒ å­—ä½“åŠ è½½å¤±è´¥ï¼Œä¸­æ–‡å°†æ˜¾ç¤ºä¹±ç :", e);
    alert("å­—ä½“åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ public/fonts/custom-font.ttf æ˜¯å¦å­˜åœ¨ã€‚");
  }
};

export const exportStoryboardPDF = async (
  scriptName: string,
  panels: any[]
) => {
  // A4 çº¸å¼ è®¾ç½® (ç«–å‘)
  const doc = new jsPDF('p', 'mm', 'a4');
  
  // ğŸ”¥ å…³é”®æ­¥éª¤ï¼šç­‰å¾…å­—ä½“åŠ è½½å®Œæˆ
  await loadChineseFont(doc);

  const pageWidth = doc.internal.pageSize.getWidth();
  const pageHeight = doc.internal.pageSize.getHeight();
  
  // å¸ƒå±€é…ç½®
  const margin = 15;
  const cardHeight = 80; // æ¯ä¸ªé•œå¤´å¡ç‰‡çš„é«˜åº¦
  const imgWidth = 90;   // å›¾ç‰‡å®½åº¦
  const imgHeight = 50.6; // å›¾ç‰‡é«˜åº¦ (16:9)
  
  // 1. ç»˜åˆ¶å°é¢
  doc.setFontSize(24);
  // ç¡®ä¿ä½¿ç”¨ä¸­æ–‡å­—ä½“
  doc.setFont("CustomFont"); 
  doc.text("CineFlow Storyboard", pageWidth / 2, 40, { align: 'center' });
  
  doc.setFontSize(16);
  // å¤„ç†å¯èƒ½åŒ…å«ä¸­æ–‡çš„é¡¹ç›®åç§°
  doc.text(`Project: ${scriptName.slice(0, 30)}`, pageWidth / 2, 60, { align: 'center' });
  
  doc.setFontSize(12);
  doc.setTextColor(100);
  doc.text(`Generated by AI.Tube | ${new Date().toLocaleDateString()}`, pageWidth / 2, 70, { align: 'center' });
  
  // 2. å¼€å§‹ç»˜åˆ¶åˆ†é•œå†…å®¹
  let yCursor = margin;
  
  // é¢„åŠ è½½æ‰€æœ‰å›¾ç‰‡
  const imagesBase64: Record<number, string> = {};
  for (const panel of panels) {
    if (panel.imageUrl) {
      try {
        imagesBase64[panel.id] = await getBase64ImageFromURL(panel.imageUrl);
      } catch (e) {
        console.warn('Image load failed', e);
      }
    }
  }

  doc.addPage(); // ç¿»åˆ°ç¬¬2é¡µ
  doc.setFont("CustomFont"); // ğŸ”¥ ç¿»é¡µåå¿…é¡»é‡æ–°è®¾ç½®å­—ä½“

  panels.forEach((panel, index) => {
    // æ£€æŸ¥æ˜¯å¦éœ€è¦æ¢é¡µ
    if (yCursor + cardHeight > pageHeight - margin) {
      doc.addPage();
      doc.setFont("CustomFont"); // ğŸ”¥ è‡ªåŠ¨æ¢é¡µä¹Ÿè¦é‡æ–°è®¾ç½®
      yCursor = margin;
    }

    // --- A. ç»˜åˆ¶åºå· ---
    doc.setFillColor(240, 240, 240); // æµ…ç°èƒŒæ™¯
    doc.rect(margin, yCursor, pageWidth - (margin * 2), cardHeight, 'F');
    
    doc.setFontSize(14);
    doc.setTextColor(0);
    doc.text(`#${index + 1}`, margin + 5, yCursor + 10);

    // --- B. ç»˜åˆ¶å›¾ç‰‡ (å·¦ä¾§) ---
    if (imagesBase64[panel.id]) {
      doc.addImage(imagesBase64[panel.id], 'JPEG', margin + 5, yCursor + 15, imgWidth, imgHeight);
    } else {
      // å ä½ç¬¦
      doc.setDrawColor(200);
      doc.rect(margin + 5, yCursor + 15, imgWidth, imgHeight); 
      doc.setFontSize(10);
      doc.text("No Image", margin + 35, yCursor + 40);
    }

    // --- C. ç»˜åˆ¶æ–‡å­—ä¿¡æ¯ (å³ä¾§) ---
    const textX = margin + imgWidth + 10;
    const textAreaWidth = pageWidth - margin - textX - 5;
    
    // æ™¯åˆ«
    doc.setFontSize(10);
    doc.setTextColor(100);
    doc.text("SHOT TYPE / æ™¯åˆ«", textX, yCursor + 20);
    doc.setFontSize(12);
    doc.setTextColor(0);
    doc.text(panel.shotType, textX, yCursor + 26);

    // åŠ¨ä½œæè¿°
    doc.setFontSize(10);
    doc.setTextColor(100);
    doc.text("ACTION / æè¿°", textX, yCursor + 36);
    doc.setFontSize(10);
    doc.setTextColor(50);
    // ä½¿ç”¨ splitTextToSize å¤„ç†è‡ªåŠ¨æ¢è¡Œ (æ”¯æŒä¸­æ–‡)
    const splitDesc = doc.splitTextToSize(panel.description || "", textAreaWidth);
    doc.text(splitDesc, textX, yCursor + 42);

    // æç¤ºè¯ (Prompt)
    doc.setFontSize(8);
    doc.setTextColor(150);
    doc.text("PROMPT REF:", textX, yCursor + cardHeight - 15);
    const splitPrompt = doc.splitTextToSize(panel.prompt || "", textAreaWidth);
    // åªæˆªå–å‰2è¡Œ
    doc.text(splitPrompt.slice(0, 2), textX, yCursor + cardHeight - 10);

    // ç§»åŠ¨å…‰æ ‡
    yCursor += cardHeight + 5;
  });

  // 3. ä¿å­˜æ–‡ä»¶
  doc.save(`Storyboard_${Date.now()}.pdf`);
};