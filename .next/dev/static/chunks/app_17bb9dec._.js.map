{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///Users/marc/AITUBE-NEW/marctubud-pixel-AITUBEV1/app/actions/director.ts"],"sourcesContent":["'use server'\n\nimport { GoogleGenAI, Type, Schema } from \"@google/genai\";\n\n// âŒ åˆ æ‰äº†å¤æ‚çš„ä»£ç†ä»£ç ï¼Œå›å½’æœ€ç®€æ¨¡å¼\nconst ai = new GoogleGenAI({ \n  apiKey: process.env.GOOGLE_API_KEY\n});\n\n// å®šä¹‰è¿”å›çš„æ•°æ®ç»“æ„\nexport interface ScriptBreakdown {\n  panels: {\n    sceneNumber: string;\n    description: string;\n    shotType: string;\n    visualPrompt: string;\n  }[];\n}\n\nexport const analyzeScript = async (script: string): Promise<ScriptBreakdown> => {\n  // è¿™é‡Œä½¿ç”¨ Google çš„ 2.0 Flash æ¨¡å‹ï¼Œé€Ÿåº¦å¿«ä¸”å…è´¹\n  const model = \"gemini-2.0-flash-exp\"; \n  \n  const systemInstruction = `\n    You are a world-class Hollywood cinematographer and storyboard artist. \n    Your task is to analyze a short script and break it down into exactly 4 key visual panels (beats) for a 2x2 grid storyboard.\n    For each panel, determine the Shot Type (CS=Close Shot, MS=Medium Shot, LS=Long Shot).\n    Create a highly detailed Stable Diffusion style prompt for a black and white sketch style image.\n    The visual prompt must describe the scene content, the angle, the lighting, and strictly specify \"black and white ink sketch style\".\n  `;\n\n  const responseSchema: Schema = {\n    type: Type.OBJECT,\n    properties: {\n      panels: {\n        type: Type.ARRAY,\n        items: {\n          type: Type.OBJECT,\n          properties: {\n            sceneNumber: { type: Type.STRING },\n            description: { type: Type.STRING },\n            shotType: { type: Type.STRING },\n            visualPrompt: { type: Type.STRING },\n          },\n          required: [\"sceneNumber\", \"description\", \"shotType\", \"visualPrompt\"],\n        },\n      },\n    },\n    required: [\"panels\"],\n  };\n\n  try {\n    const response = await ai.models.generateContent({\n      model,\n      contents: `Analyze this script and generate a 4-panel breakdown: \"${script}\"`,\n      config: {\n        systemInstruction,\n        responseMimeType: \"application/json\",\n        responseSchema,\n      },\n    });\n\n    if (!response.text) {\n      throw new Error(\"Gemini æ²¡æœ‰è¿”å›æ–‡æœ¬\");\n    }\n\n    return JSON.parse(response.text) as ScriptBreakdown;\n\n  } catch (error: any) {\n    console.error(\"AI Analysis Failed:\", error);\n    throw new Error(`å‰§æœ¬åˆ†æå¤±è´¥: ${error.message}`);\n  }\n};"],"names":[],"mappings":";;;;;;;IAmBa,gBAAA,WAAA,GAAA,IAAA,kPAAA,EAAA,8CAAA,uOAAA,EAAA,KAAA,GAAA,6OAAA,EAAA"}},
    {"offset": {"line": 19, "column": 0}, "map": {"version":3,"sources":["file:///Users/marc/AITUBE-NEW/marctubud-pixel-AITUBEV1/app/actions/generate.ts"],"sourcesContent":["'use server'\n\nimport { createClient } from '@/utils/supabase/server'\nimport { revalidatePath } from 'next/cache'\n\nexport async function generateShotImage(shotId: string, prompt: string, projectId: string) {\n  console.log(\"ğŸš€ [AI] å¼€å§‹ç”Ÿæˆé•œå¤´:\", shotId);\n\n  try {\n    const supabase = await createClient();\n\n    // 1. ä½¿ç”¨ Pollinations AI ç”Ÿæˆ (å…è´¹ã€æ— éœ€ Key)\n    // å®ƒæ˜¯é€šè¿‡ URL ç›´æ¥è¿”å›å›¾ç‰‡çš„ï¼Œéå¸¸æ–¹ä¾¿\n    // æˆ‘ä»¬å¯¹ prompt è¿›è¡Œç¼–ç ï¼Œé˜²æ­¢ç‰¹æ®Šå­—ç¬¦æŠ¥é”™\n    const encodedPrompt = encodeURIComponent(prompt + \", cinematic lighting, 8k, photorealistic\");\n    const imageUrl = `https://image.pollinations.ai/prompt/${encodedPrompt}?width=1280&height=720&model=flux`; // ä½¿ç”¨ flux æ¨¡å‹ï¼Œæ•ˆæœæ›´å¥½\n\n    console.log(\"ğŸ¨ è¯·æ±‚ Pollinations:\", imageUrl);\n\n    // 2. ä¸‹è½½ç”Ÿæˆçš„å›¾ç‰‡ (è·å–äºŒè¿›åˆ¶æµ)\n    const response = await fetch(imageUrl);\n    \n    if (!response.ok) {\n        throw new Error(`å›¾ç‰‡ç”Ÿæˆå¤±è´¥: ${response.statusText}`);\n    }\n\n    const arrayBuffer = await response.arrayBuffer();\n    const imageBuffer = Buffer.from(arrayBuffer);\n\n    // 3. ä¸Šä¼ åˆ° Supabase Storage\n    const fileName = `${projectId}/${shotId}_${Date.now()}.png`;\n\n    const { data: uploadData, error: uploadError } = await supabase\n      .storage\n      .from('shots')\n      .upload(fileName, imageBuffer, {\n        contentType: 'image/png',\n        upsert: true\n      });\n\n    if (uploadError) {\n        console.error(\"Storage Upload Error:\", uploadError);\n        throw new Error(\"å›¾ç‰‡ä¸Šä¼ åˆ°å­˜å‚¨æ¡¶å¤±è´¥\");\n    }\n\n    // 4. è·å–å…¬å¼€é“¾æ¥\n    const { data: { publicUrl } } = supabase\n      .storage\n      .from('shots')\n      .getPublicUrl(fileName);\n\n    // 5. æ›´æ–°æ•°æ®åº“\n    const { error: dbError } = await supabase\n      .from('shots')\n      .update({\n        image_url: publicUrl,\n        status: 'completed'\n      })\n      .eq('id', shotId);\n\n    if (dbError) throw dbError;\n\n    console.log(\"âœ… [AI] ç”Ÿæˆå¹¶ä¸Šä¼ æˆåŠŸ:\", publicUrl);\n    return { success: true, url: publicUrl };\n\n  } catch (error: any) {\n    console.error(\"ğŸ”¥ [AI Fail]:\", error);\n    \n    // å¤±è´¥æ—¶è®°å½•çŠ¶æ€\n    const supabase = await createClient();\n    await supabase.from('shots').update({ status: 'failed' }).eq('id', shotId);\n\n    return { success: false, message: error.message };\n  }\n}\n"],"names":[],"mappings":";;;;;;;IAKsB,oBAAA,WAAA,GAAA,IAAA,kPAAA,EAAA,8CAAA,uOAAA,EAAA,KAAA,GAAA,6OAAA,EAAA"}},
    {"offset": {"line": 34, "column": 0}, "map": {"version":3,"sources":["file:///Users/marc/AITUBE-NEW/marctubud-pixel-AITUBEV1/app/tools/cineflow/storyboard/page.tsx"],"sourcesContent":["'use client'\n\nimport React, { useState } from 'react';\nimport { Film, Clapperboard, Loader2, ArrowLeft } from 'lucide-react';\nimport { toast, Toaster } from 'sonner';\nimport Link from 'next/link';\nimport { analyzeScript } from '@/app/actions/director'; // åˆšåˆšå†™çš„åç«¯\nimport { generateShotImage } from '@/app/actions/generate'; // ä¹‹å‰å†™çš„ç”»å›¾å·¥å…·\n\n// å®šä¹‰ç±»å‹\ntype StoryboardPanel = {\n  id: number;\n  description: string;\n  shotType: string;\n  prompt: string;\n  imageUrl?: string;\n  isLoading: boolean;\n}\n\nexport default function StoryboardPage() {\n  const [script, setScript] = useState('');\n  const [isProcessing, setIsProcessing] = useState(false);\n  const [statusMessage, setStatusMessage] = useState('');\n  const [panels, setPanels] = useState<StoryboardPanel[]>([]);\n\n  // ä¸´æ—¶é¡¹ç›®IDï¼Œç”¨äºæ•´ç†å›¾ç‰‡å­˜å‚¨\n  const tempProjectId = \"temp_workspace\"; \n\n  const handleGenerate = async () => {\n    if (!script.trim()) return;\n    \n    setIsProcessing(true);\n    setPanels([]);\n    setStatusMessage('å¯¼æ¼” AI æ­£åœ¨é˜…è¯»å‰§æœ¬...');\n\n    try {\n      // 1. è°ƒç”¨ Gemini åˆ†æå‰§æœ¬\n      const breakdown = await analyzeScript(script);\n      \n      const initialPanels: StoryboardPanel[] = breakdown.panels.map((p, index) => ({\n        id: index,\n        description: p.description,\n        shotType: p.shotType,\n        prompt: p.visualPrompt,\n        isLoading: true,\n      }));\n      \n      setPanels(initialPanels);\n      setStatusMessage('æ­£åœ¨ç»˜åˆ¶åˆ†é•œè‰å›¾...');\n\n      // 2. å¹¶è¡Œè°ƒç”¨ AI ç”Ÿæˆå›¾ç‰‡\n      const promises = initialPanels.map(async (panel) => {\n        try {\n          // è°ƒç”¨ä¹‹å‰çš„ Pollinations ç”»å›¾æœåŠ¡\n          // è¿™é‡Œæˆ‘ä»¬ç”Ÿæˆä¸€ä¸ªä¸´æ—¶çš„ ID\n          const tempShotId = `storyboard_${Date.now()}_${panel.id}`;\n          \n          const res = await generateShotImage(tempShotId, panel.prompt, tempProjectId);\n\n          if (res.success && res.url) {\n            setPanels(current => \n                current.map(p => p.id === panel.id \n                  ? { ...p, imageUrl: res.url, isLoading: false } \n                  : p\n                )\n              );\n          } else {\n             throw new Error(res.message);\n          }\n\n        } catch (error) {\n          console.error(`Panel ${panel.id} failed`, error);\n          setPanels(current => \n            current.map(p => p.id === panel.id \n              ? { ...p, isLoading: false } // åœæ­¢ loading\n              : p\n            )\n          );\n          // ä¸å¼¹çª—æŠ¥é”™ï¼Œä»¥å… 4 ä¸ªçª—å£ä¸€èµ·å¼¹å¤ªåµï¼Œåªåœ¨æ§åˆ¶å°è®°å½•\n        }\n      });\n\n      await Promise.all(promises);\n      setStatusMessage('åˆ†é•œç»˜åˆ¶å®Œæˆ');\n      toast.success('ç”Ÿæˆå®Œæ¯•ï¼');\n\n    } catch (error: any) {\n      console.error(error);\n      setStatusMessage('ç”Ÿæˆå‡ºé”™ï¼Œè¯·é‡è¯•');\n      toast.error('AI åˆ†æå¤±è´¥: ' + error.message);\n    } finally {\n      setIsProcessing(false);\n    }\n  };\n\n  return (\n    <div className=\"min-h-screen bg-[#0A0A0A] text-white p-6\">\n      <Toaster position=\"top-center\" richColors />\n      \n      {/* é¡¶éƒ¨å¯¼èˆª */}\n      <div className=\"max-w-7xl mx-auto mb-8 flex items-center justify-between\">\n        <Link href=\"/tools/cineflow\" className=\"inline-flex items-center text-zinc-500 hover:text-white transition-colors\">\n            <ArrowLeft className=\"w-4 h-4 mr-2\" /> è¿”å›å·¥ä½œå°\n        </Link>\n        <div className=\"text-xs text-zinc-600 border border-zinc-800 px-2 py-1 rounded\">\n            Director Mode (Alpha)\n        </div>\n      </div>\n\n      <div className=\"max-w-7xl mx-auto flex flex-col lg:flex-row gap-8 min-h-[600px]\">\n        \n        {/* å·¦ä¾§ï¼šè¾“å…¥åŒº */}\n        <div className=\"w-full lg:w-1/3 bg-[#111] p-6 rounded-2xl border border-white/10 flex flex-col gap-6 h-fit\">\n          <div>\n            <h2 className=\"text-xl font-bold text-white mb-4 flex items-center gap-2\">\n              <Clapperboard className=\"text-yellow-500\" />\n              å‰§æœ¬è¾“å…¥\n            </h2>\n            <textarea\n              className=\"w-full h-60 bg-black/50 border border-white/10 rounded-xl p-4 text-gray-300 focus:border-yellow-500 focus:outline-none resize-none transition-colors placeholder-gray-700\"\n              placeholder=\"è¯·åœ¨è¿™é‡Œè¾“å…¥ä½ çš„æ•…äº‹ã€‚ä¾‹å¦‚ï¼šä¸€ä¸ªèµ›åšæœ‹å…‹é£æ ¼çš„ä¾¦æ¢ç«™åœ¨é›¨ä¸­ï¼Œçœ‹ç€éœ“è™¹ç¯é—ªçƒï¼Œæ‰‹é‡Œæ‹¿ç€ä¸€å¼ æ—§ç…§ç‰‡...\"\n              value={script}\n              onChange={(e) => setScript(e.target.value)}\n            />\n          </div>\n\n          <button\n            onClick={handleGenerate}\n            disabled={isProcessing || !script.trim()}\n            className=\"w-full py-4 bg-yellow-500 hover:bg-yellow-400 disabled:opacity-50 disabled:cursor-not-allowed text-black font-black rounded-xl uppercase tracking-wider flex items-center justify-center gap-2 transition-all shadow-lg shadow-yellow-500/20\"\n          >\n            {isProcessing ? <Loader2 className=\"animate-spin\" /> : <Film />}\n            å¼€å§‹å¯¼æ¼” (Direct)\n          </button>\n          \n          {statusMessage && (\n            <div className=\"bg-zinc-900/50 p-3 rounded-lg text-center\">\n                <p className=\"text-sm text-yellow-500/80 animate-pulse font-mono\">{statusMessage}</p>\n            </div>\n          )}\n        </div>\n\n        {/* å³ä¾§ï¼šåˆ†é•œå±•ç¤ºåŒº */}\n        <div className=\"w-full lg:w-2/3\">\n          {panels.length === 0 ? (\n            <div className=\"h-full min-h-[400px] flex flex-col items-center justify-center bg-[#111] rounded-2xl border border-dashed border-white/10 text-zinc-600\">\n              <Film className=\"w-20 h-20 mb-4 opacity-10\" />\n              <p className=\"font-bold text-lg\">ç­‰å¾…è¾“å…¥å‰§æœ¬...</p>\n              <p className=\"text-sm opacity-50\">AI å°†è‡ªåŠ¨ä¸ºä½ ç”Ÿæˆ 4 æ ¼å…³é”®å¸§</p>\n            </div>\n          ) : (\n            <div className=\"grid grid-cols-1 md:grid-cols-2 gap-6\">\n              {panels.map((panel) => (\n                <div key={panel.id} className=\"group relative aspect-video bg-black border border-white/10 rounded-xl overflow-hidden hover:border-yellow-500/50 transition-all shadow-xl\">\n                  {panel.isLoading ? (\n                    <div className=\"absolute inset-0 flex flex-col gap-3 items-center justify-center bg-zinc-900\">\n                      <Loader2 className=\"w-8 h-8 text-yellow-500 animate-spin\" />\n                      <span className=\"text-xs text-yellow-500/80 font-mono tracking-widest\">{panel.shotType}</span>\n                    </div>\n                  ) : panel.imageUrl ? (\n                    <>\n                        <img src={panel.imageUrl} alt={panel.description} className=\"w-full h-full object-cover opacity-90 group-hover:opacity-100 transition-opacity\" />\n                        \n                        {/* åº•éƒ¨æè¿°é®ç½© */}\n                        <div className=\"absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black via-black/80 to-transparent p-4 pt-12 translate-y-2 group-hover:translate-y-0 transition-transform\">\n                            <div className=\"flex items-center gap-2 mb-1\">\n                                <span className=\"text-[10px] font-bold bg-yellow-500 text-black px-1.5 rounded\">{panel.shotType}</span>\n                            </div>\n                            <p className=\"text-xs text-gray-300 line-clamp-2 leading-relaxed\">{panel.description}</p>\n                        </div>\n                    </>\n                  ) : (\n                    <div className=\"absolute inset-0 flex items-center justify-center text-red-500 text-xs\">ç”Ÿæˆå¤±è´¥</div>\n                  )}\n                  \n                  {/* å·¦ä¸Šè§’åºå· */}\n                  <div className=\"absolute top-0 left-0 bg-black/50 backdrop-blur px-3 py-1.5 rounded-br-lg border-r border-b border-white/10 z-10\">\n                    <span className=\"text-yellow-500 font-black text-sm\">#{panel.id + 1}</span>\n                  </div>\n                </div>\n              ))}\n            </div>\n          )}\n        </div>\n      </div>\n    </div>\n  );\n}"],"names":[],"mappings":"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"}}]
}