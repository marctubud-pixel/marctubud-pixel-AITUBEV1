{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///Users/marc/AITUBE-NEW/marctubud-pixel-AITUBEV1/app/actions/director.ts"],"sourcesContent":["'use server'\n\nimport { GoogleGenAI, Type, Schema } from \"@google/genai\";\n// ✅ 引入 undici 来强制控制网络\nimport { setGlobalDispatcher, ProxyAgent } from 'undici';\n\n// ============================================================\n// 🔥 核弹级代理补丁：强制 Node.js 走 Clash 的 7890 端口\n// ============================================================\n// 只有在开发环境下生效，防止影响上线\nif (process.env.NODE_ENV === 'development') {\n  try {\n    // 这里填你的代理地址 (根据你刚才的截图是 7890)\n    const proxyUrl = 'http://127.0.0.1:7890';\n    const dispatcher = new ProxyAgent(proxyUrl);\n    setGlobalDispatcher(dispatcher);\n    console.log(`🔒 [Proxy] 已强制接管网络请求，流量转发至: ${proxyUrl}`);\n  } catch (err) {\n    console.error('代理设置失败:', err);\n  }\n}\n// ============================================================\n\nconst ai = new GoogleGenAI({ \n  apiKey: process.env.GOOGLE_API_KEY\n});\n\nexport interface ScriptBreakdown {\n  panels: {\n    sceneNumber: string;\n    description: string;\n    shotType: string;\n    visualPrompt: string;\n  }[];\n}\n\nexport const analyzeScript = async (script: string): Promise<ScriptBreakdown> => {\n  // 使用 2.0 Flash 模型\n  const model = \"gemini-2.0-flash-exp\"; \n  \n  const systemInstruction = `\n    You are a world-class Hollywood cinematographer and storyboard artist. \n    Your task is to analyze a short script and break it down into exactly 4 key visual panels (beats) for a 2x2 grid storyboard.\n    For each panel, determine the Shot Type (CS=Close Shot, MS=Medium Shot, LS=Long Shot).\n    Create a highly detailed Stable Diffusion style prompt for a black and white sketch style image.\n    The visual prompt must describe the scene content, the angle, the lighting, and strictly specify \"black and white ink sketch style\".\n  `;\n\n  const responseSchema: Schema = {\n    type: Type.OBJECT,\n    properties: {\n      panels: {\n        type: Type.ARRAY,\n        items: {\n          type: Type.OBJECT,\n          properties: {\n            sceneNumber: { type: Type.STRING },\n            description: { type: Type.STRING },\n            shotType: { type: Type.STRING },\n            visualPrompt: { type: Type.STRING },\n          },\n          required: [\"sceneNumber\", \"description\", \"shotType\", \"visualPrompt\"],\n        },\n      },\n    },\n    required: [\"panels\"],\n  };\n\n  try {\n    const response = await ai.models.generateContent({\n      model,\n      contents: `Analyze this script and generate a 4-panel breakdown: \"${script}\"`,\n      config: {\n        systemInstruction,\n        responseMimeType: \"application/json\",\n        responseSchema,\n      },\n    });\n\n    if (!response.text) {\n      throw new Error(\"Gemini 没有返回文本\");\n    }\n\n    return JSON.parse(response.text) as ScriptBreakdown;\n\n  } catch (error: any) {\n    console.error(\"AI Analysis Failed:\", error);\n    throw new Error(`剧本分析失败: ${error.message} (请检查 7890 端口是否开启)`);\n  }\n};"],"names":[],"mappings":";;;;;;;IAoCa,gBAAA,WAAA,GAAA,IAAA,kPAAA,EAAA,8CAAA,uOAAA,EAAA,KAAA,GAAA,6OAAA,EAAA"}},
    {"offset": {"line": 19, "column": 0}, "map": {"version":3,"sources":["file:///Users/marc/AITUBE-NEW/marctubud-pixel-AITUBEV1/app/actions/generate.ts"],"sourcesContent":["'use server'\n\nimport { createClient } from '@/utils/supabase/server'\n// ✅ 引入代理库\nimport { setGlobalDispatcher, ProxyAgent } from 'undici';\n\n// ============================================================\n// 🔥 强制代理补丁\n// ============================================================\nif (process.env.NODE_ENV === 'development') {\n  try {\n    const proxyUrl = 'http://127.0.0.1:7890'; // 你的端口\n    const dispatcher = new ProxyAgent({\n      uri: proxyUrl,\n      connect: {\n        timeout: 60000 // 增加连接超时到 60秒\n      }\n    });\n    setGlobalDispatcher(dispatcher);\n  } catch (err) {\n    console.error('代理设置失败:', err);\n  }\n}\n\n// 帮助函数：延迟等待\nconst delay = (ms: number) => new Promise(resolve => setTimeout(resolve, ms));\n\nexport async function generateShotImage(shotId: string, prompt: string, projectId: string) {\n  const supabase = await createClient();\n  \n  // 🔄 重试机制：最多尝试 3 次\n  const MAX_RETRIES = 3;\n  \n  for (let i = 0; i < MAX_RETRIES; i++) {\n    try {\n      // 1. 构造请求\n      // 💡 提速小技巧：如果你觉得太慢，可以把下面的 model=flux 改成 model=turbo\n      const encodedPrompt = encodeURIComponent(prompt + \", cinematic lighting, 8k, photorealistic, monochrome sketch style\");\n      const imageUrl = `https://image.pollinations.ai/prompt/${encodedPrompt}?width=1280&height=720&model=turbo&seed=${Math.random()}`; \n\n      // 2. 下载图片 (设置 60秒 超时)\n      const response = await fetch(imageUrl, {\n        signal: AbortSignal.timeout(60000) // 60秒后才算超时\n      });\n      \n      if (!response.ok) {\n          throw new Error(`HTTP error! status: ${response.status}`);\n      }\n\n      const arrayBuffer = await response.arrayBuffer();\n      const imageBuffer = Buffer.from(arrayBuffer);\n\n      // 3. 上传到 Supabase\n      const fileName = `${projectId}/${shotId}_${Date.now()}.png`;\n\n      const { error: uploadError } = await supabase\n        .storage\n        .from('shots')\n        .upload(fileName, imageBuffer, {\n          contentType: 'image/png',\n          upsert: true\n        });\n\n      if (uploadError) throw new Error(\"上传存储桶失败\");\n\n      // 4. 获取链接\n      const { data: { publicUrl } } = supabase\n        .storage\n        .from('shots')\n        .getPublicUrl(fileName);\n\n      // 5. 更新数据库 (如果不是临时预览)\n      if (shotId && !shotId.startsWith('storyboard_')) {\n          await supabase.from('shots').update({\n              image_url: publicUrl,\n              status: 'completed'\n          }).eq('id', shotId);\n      }\n\n      // ✅ 成功了！直接返回，跳出循环\n      return { success: true, url: publicUrl };\n\n    } catch (error: any) {\n      console.warn(`⚠️ 第 ${i + 1} 次生成失败:`, error.message);\n      \n      // 如果是最后一次尝试还在失败，那就真的抛出错误\n      if (i === MAX_RETRIES - 1) {\n        return { success: false, message: `多次重试后失败: ${error.message}` };\n      }\n      \n      // 等待 1 秒后再重试\n      await delay(1000);\n    }\n  }\n  \n  return { success: false, message: \"未知错误\" };\n}"],"names":[],"mappings":";;;;;;;IA2BsB,oBAAA,WAAA,GAAA,IAAA,kPAAA,EAAA,8CAAA,uOAAA,EAAA,KAAA,GAAA,6OAAA,EAAA"}},
    {"offset": {"line": 34, "column": 0}, "map": {"version":3,"sources":["file:///Users/marc/AITUBE-NEW/marctubud-pixel-AITUBEV1/app/tools/cineflow/storyboard/page.tsx"],"sourcesContent":["'use client'\n\nimport React, { useState } from 'react';\nimport { Film, Clapperboard, Loader2, ArrowLeft } from 'lucide-react';\nimport { toast, Toaster } from 'sonner';\nimport Link from 'next/link';\nimport { analyzeScript } from '@/app/actions/director'; // 刚刚写的后端\nimport { generateShotImage } from '@/app/actions/generate'; // 之前写的画图工具\n\n// 定义类型\ntype StoryboardPanel = {\n  id: number;\n  description: string;\n  shotType: string;\n  prompt: string;\n  imageUrl?: string;\n  isLoading: boolean;\n}\n\nexport default function StoryboardPage() {\n  const [script, setScript] = useState('');\n  const [isProcessing, setIsProcessing] = useState(false);\n  const [statusMessage, setStatusMessage] = useState('');\n  const [panels, setPanels] = useState<StoryboardPanel[]>([]);\n\n  // 临时项目ID，用于整理图片存储\n  const tempProjectId = \"temp_workspace\"; \n\n  const handleGenerate = async () => {\n    if (!script.trim()) return;\n    \n    setIsProcessing(true);\n    setPanels([]);\n    setStatusMessage('导演 AI 正在阅读剧本...');\n\n    try {\n      // 1. 调用 Gemini 分析剧本\n      const breakdown = await analyzeScript(script);\n      \n      const initialPanels: StoryboardPanel[] = breakdown.panels.map((p, index) => ({\n        id: index,\n        description: p.description,\n        shotType: p.shotType,\n        prompt: p.visualPrompt,\n        isLoading: true,\n      }));\n      \n      setPanels(initialPanels);\n      setStatusMessage('正在绘制分镜草图...');\n\n      // 2. 并行调用 AI 生成图片\n      const promises = initialPanels.map(async (panel) => {\n        try {\n          // 调用之前的 Pollinations 画图服务\n          // 这里我们生成一个临时的 ID\n          const tempShotId = `storyboard_${Date.now()}_${panel.id}`;\n          \n          const res = await generateShotImage(tempShotId, panel.prompt, tempProjectId);\n\n          if (res.success && res.url) {\n            setPanels(current => \n                current.map(p => p.id === panel.id \n                  ? { ...p, imageUrl: res.url, isLoading: false } \n                  : p\n                )\n              );\n          } else {\n             throw new Error(res.message);\n          }\n\n        } catch (error) {\n          console.error(`Panel ${panel.id} failed`, error);\n          setPanels(current => \n            current.map(p => p.id === panel.id \n              ? { ...p, isLoading: false } // 停止 loading\n              : p\n            )\n          );\n          // 不弹窗报错，以免 4 个窗口一起弹太吵，只在控制台记录\n        }\n      });\n\n      await Promise.all(promises);\n      setStatusMessage('分镜绘制完成');\n      toast.success('生成完毕！');\n\n    } catch (error: any) {\n      console.error(error);\n      setStatusMessage('生成出错，请重试');\n      toast.error('AI 分析失败: ' + error.message);\n    } finally {\n      setIsProcessing(false);\n    }\n  };\n\n  return (\n    <div className=\"min-h-screen bg-[#0A0A0A] text-white p-6\">\n      <Toaster position=\"top-center\" richColors />\n      \n      {/* 顶部导航 */}\n      <div className=\"max-w-7xl mx-auto mb-8 flex items-center justify-between\">\n        <Link href=\"/tools/cineflow\" className=\"inline-flex items-center text-zinc-500 hover:text-white transition-colors\">\n            <ArrowLeft className=\"w-4 h-4 mr-2\" /> 返回工作台\n        </Link>\n        <div className=\"text-xs text-zinc-600 border border-zinc-800 px-2 py-1 rounded\">\n            Director Mode (Alpha)\n        </div>\n      </div>\n\n      <div className=\"max-w-7xl mx-auto flex flex-col lg:flex-row gap-8 min-h-[600px]\">\n        \n        {/* 左侧：输入区 */}\n        <div className=\"w-full lg:w-1/3 bg-[#111] p-6 rounded-2xl border border-white/10 flex flex-col gap-6 h-fit\">\n          <div>\n            <h2 className=\"text-xl font-bold text-white mb-4 flex items-center gap-2\">\n              <Clapperboard className=\"text-yellow-500\" />\n              剧本输入\n            </h2>\n            <textarea\n              className=\"w-full h-60 bg-black/50 border border-white/10 rounded-xl p-4 text-gray-300 focus:border-yellow-500 focus:outline-none resize-none transition-colors placeholder-gray-700\"\n              placeholder=\"请在这里输入你的故事。例如：一个赛博朋克风格的侦探站在雨中，看着霓虹灯闪烁，手里拿着一张旧照片...\"\n              value={script}\n              onChange={(e) => setScript(e.target.value)}\n            />\n          </div>\n\n          <button\n            onClick={handleGenerate}\n            disabled={isProcessing || !script.trim()}\n            className=\"w-full py-4 bg-yellow-500 hover:bg-yellow-400 disabled:opacity-50 disabled:cursor-not-allowed text-black font-black rounded-xl uppercase tracking-wider flex items-center justify-center gap-2 transition-all shadow-lg shadow-yellow-500/20\"\n          >\n            {isProcessing ? <Loader2 className=\"animate-spin\" /> : <Film />}\n            开始导演 (Direct)\n          </button>\n          \n          {statusMessage && (\n            <div className=\"bg-zinc-900/50 p-3 rounded-lg text-center\">\n                <p className=\"text-sm text-yellow-500/80 animate-pulse font-mono\">{statusMessage}</p>\n            </div>\n          )}\n        </div>\n\n        {/* 右侧：分镜展示区 */}\n        <div className=\"w-full lg:w-2/3\">\n          {panels.length === 0 ? (\n            <div className=\"h-full min-h-[400px] flex flex-col items-center justify-center bg-[#111] rounded-2xl border border-dashed border-white/10 text-zinc-600\">\n              <Film className=\"w-20 h-20 mb-4 opacity-10\" />\n              <p className=\"font-bold text-lg\">等待输入剧本...</p>\n              <p className=\"text-sm opacity-50\">AI 将自动为你生成 4 格关键帧</p>\n            </div>\n          ) : (\n            <div className=\"grid grid-cols-1 md:grid-cols-2 gap-6\">\n              {panels.map((panel) => (\n                <div key={panel.id} className=\"group relative aspect-video bg-black border border-white/10 rounded-xl overflow-hidden hover:border-yellow-500/50 transition-all shadow-xl\">\n                  {panel.isLoading ? (\n                    <div className=\"absolute inset-0 flex flex-col gap-3 items-center justify-center bg-zinc-900\">\n                      <Loader2 className=\"w-8 h-8 text-yellow-500 animate-spin\" />\n                      <span className=\"text-xs text-yellow-500/80 font-mono tracking-widest\">{panel.shotType}</span>\n                    </div>\n                  ) : panel.imageUrl ? (\n                    <>\n                        <img src={panel.imageUrl} alt={panel.description} className=\"w-full h-full object-cover opacity-90 group-hover:opacity-100 transition-opacity\" />\n                        \n                        {/* 底部描述遮罩 */}\n                        <div className=\"absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black via-black/80 to-transparent p-4 pt-12 translate-y-2 group-hover:translate-y-0 transition-transform\">\n                            <div className=\"flex items-center gap-2 mb-1\">\n                                <span className=\"text-[10px] font-bold bg-yellow-500 text-black px-1.5 rounded\">{panel.shotType}</span>\n                            </div>\n                            <p className=\"text-xs text-gray-300 line-clamp-2 leading-relaxed\">{panel.description}</p>\n                        </div>\n                    </>\n                  ) : (\n                    <div className=\"absolute inset-0 flex items-center justify-center text-red-500 text-xs\">生成失败</div>\n                  )}\n                  \n                  {/* 左上角序号 */}\n                  <div className=\"absolute top-0 left-0 bg-black/50 backdrop-blur px-3 py-1.5 rounded-br-lg border-r border-b border-white/10 z-10\">\n                    <span className=\"text-yellow-500 font-black text-sm\">#{panel.id + 1}</span>\n                  </div>\n                </div>\n              ))}\n            </div>\n          )}\n        </div>\n      </div>\n    </div>\n  );\n}"],"names":[],"mappings":"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"}}]
}